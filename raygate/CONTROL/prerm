#!/bin/sh

echo "[RayGate] Stopping services before removal..."

if [ -x /opt/etc/init.d/S99raygate ]; then
    /opt/etc/init.d/S99raygate stop
fi

if pgrep -f "/opt/sbin/xray run" >/dev/null 2>&1; then
    echo "[RayGate] Killing remaining Xray processes..."
    pkill -9 -f "/opt/sbin/xray run"
fi

if pgrep -f "rayweb.py" >/dev/null 2>&1; then
    for pid in $(pgrep -f "rayweb.py"); do
        kill "$pid" 2>/dev/null
    done
    echo "[RayGate] RayWeb killed."
else
    echo "[RayGate] RayWeb not running."
fi

if pgrep -f "raygate_watchdog" >/dev/null 2>&1; then
    echo "[RayGate] Stopping WatchDog..."
    for pid in $(pgrep -f "raygate_watchdog"); do
        kill "$pid" 2>/dev/null
    done
    echo "[RayGate] WatchDog stopped."
else
    echo "[RayGate] WatchDog is not running."
fi

echo "[RayGate] Clearing opkg cache..."
rm -rf /opt/var/opkg-lists/*

rm -f /opt/etc/rc.d/S99raygate

rm -f /opt/var/run/xray.pid
rm -f /opt/var/run/rayweb.pid

rm -f /opt/var/log/xray/xray_output.log
rm -f /opt/bin/raygate/rayweb/rayweb.log
rm -f /tmp/xray_test.log

echo "[RayGate] Cleanup before removal done."

exit 0
