#!/bin/sh
set -e

echo "=== RayGate Post-install script ==="

# === Зависимости ===
echo -n "[1/9] Installing dependencies... "
opkg update >/dev/null 2>&1
opkg install cron >/dev/null 2>&1
pip3 install --no-cache-dir flask bcrypt >/dev/null 2>&1
echo "OK!"

# === Проверка директорий ===
echo -n "[2/9] Checking directories... "
mkdir -p /opt/var/run
mkdir -p /opt/etc/rc.d
mkdir -p /opt/etc/xray
mkdir -p /opt/var/log/xray
echo "OK!"

CONFIG_PATH="/opt/etc/xray/config.json"
RAYGATE_PATH="/opt/bin/raygate/"
RAYWEB_PATH="$RAYGATE_PATHrayweb/rayweb.py"

# === Определяем системный DNS порт ===
echo -n "[3/9] Detecting system DNS port... "
DNS_SYS_PORT=$(grep -m1 '^port=' /opt/etc/dnsmasq.conf 2>/dev/null | cut -d= -f2)
[ -n "$DNS_SYS_PORT" ] || DNS_SYS_PORT=$(grep -m1 '^port=' /etc/dnsmasq.conf 2>/dev/null | cut -d= -f2)
[ -n "$DNS_SYS_PORT" ] || DNS_SYS_PORT=53
echo "$DNS_SYS_PORT"

# === Настройка RayGate скриптов ===
echo -n "[4/9] Configuring RayGate scripts... "
IFACE=$(ip -o link show | awk -F': ' '$2 ~ /^br/ {print $2; exit}')
sed -i "s|__IFACE__|$IFACE|g" /opt/etc/init.d/S99raygate
sed -i "s|__IFACE__|$IFACE|g" /opt/etc/ndm/netfilter.d/50-raygate-hook.sh
sed -i "s|__SYSDNS__|$DNS_SYS_PORT|g" $RAYGATE_PATHraygate_add.sh
sed -i "s|__SYSDNS__|$DNS_SYS_PORT|g" $RAYGATE_PATHraygate_rem.sh
sed -i "s|__SYSDNS__|$DNS_SYS_PORT|g" $RAYGATE_PATHraygate_sync.sh
echo "OK!"

# === config.json ===
echo "[5/9] Writing config..."
echo "[5/9] Please enter your vless:// link:"
read -r VLESS

ADDRESS=$(echo "$VLESS" | sed -n 's#.*@\([^:]*\):.*#\1#p')
PORT=$(echo "$VLESS" | sed -n 's#.*:\([0-9]*\)?.*#\1#p')
UUID=$(echo "$VLESS" | sed -n 's#vless://\([^@]*\)@.*#\1#p')
SNI=$(echo "$VLESS" | tr '&' '\n' | grep '^sni=' | cut -d= -f2)
PUBKEY=$(echo "$VLESS" | tr '&' '\n' | grep '^pbk=' | cut -d= -f2)
SHORTID=$(echo "$VLESS" | tr '&' '\n' | grep '^sid=' | cut -d= -f2 | cut -d'#' -f1)

esc() { echo "$1" | sed 's/[&|/]/\\&/g'; }

ADDRESS_ESC=$(esc "$ADDRESS")
PORT_ESC=$(esc "$PORT")
UUID_ESC=$(esc "$UUID")
SNI_ESC=$(esc "$SNI")
PUBKEY_ESC=$(esc "$PUBKEY")
SHORTID_ESC=$(esc "$SHORTID")

sed -i "s|__ADDRESS__|$ADDRESS_ESC|g" "$CONFIG_PATH"
sed -i "s|__PORT__|$PORT_ESC|g" "$CONFIG_PATH"
sed -i "s|__UUID__|$UUID_ESC|g" "$CONFIG_PATH"
sed -i "s|__SNI__|$SNI_ESC|g" "$CONFIG_PATH"
sed -i "s|__PUBKEY__|$PUBKEY_ESC|g" "$CONFIG_PATH"
sed -i "s|__SHORTID__|$SHORTID_ESC|g" "$CONFIG_PATH"
echo "[5/9] config.json created!"

# === rayweb.py ===
echo "[6/9] Configuring web interface..."
echo -n "[6/9] Please enter USERNAME for rayweb authorization: "
read USERNAME
echo "[6/9] Please enter PASSWORD for rayweb authorization: "
read -s PASSWORD
PASSHASH=$(python3 -c "import bcrypt; print(bcrypt.hashpw('$PASSWORD'.encode(), bcrypt.gensalt()).decode())")
SECRET=$(head -c 16 /dev/urandom | hexdump -v -e '/1 "%02x"')

USERNAME_ESC=$(esc "$USERNAME")
PASSHASH_ESC=$(esc "$PASSHASH")
SECRET_ESC=$(esc "$SECRET")

sed -i "s|__USERNAME__|$USERNAME_ESC|g" "$RAYWEB_PATH"
sed -i "s|__PASSHASH__|$PASSHASH_ESC|g" "$RAYWEB_PATH"
sed -i "s|__SECRET__|$SECRET_ESC|g" "$RAYWEB_PATH"
echo "[6/9] rayweb.py configured!"

# === Права на исполнение ===
echo -n "[7/9] Setting permissions... "
chmod +x "$RAYWEB_PATH"
chmod +x $RAYGATE_PATHraygate_add.sh
chmod +x $RAYGATE_PATHraygate_rem.sh
chmod +x $RAYGATE_PATHraygate_sync.sh
chmod +x /opt/etc/ndm/netfilter.d/50-raygate-hook.sh
chmod +x /opt/etc/init.d/S99raygate
echo "OK!"

# === Cron для синка ===
echo -n "[8/9] Installing cron job for sync... "
mkdir -p /opt/etc/crontabs
CRON_FILE="/opt/etc/crontabs/root"

# если файла нет — создаём с заголовками
if [ ! -f "$CRON_FILE" ]; then
  cat > "$CRON_FILE" <<EOF
SHELL=/bin/sh
PATH=/opt/bin:/opt/sbin:/sbin:/bin:/usr/sbin:/usr/bin
* * * * * $RAYGATE_PATHraygate_sync.sh
EOF
else
  # если задачи ещё нет — дописываем
  grep -q raygate_sync.sh "$CRON_FILE" 2>/dev/null || \
    echo "* * * * * $RAYGATE_PATHraygate_sync.sh" >> "$CRON_FILE"
fi

chown root:root "$CRON_FILE"
chmod 600 "$CRON_FILE"

killall crond 2>/dev/null
crond -c /opt/etc/crontabs -L /opt/var/log/cron.log

echo "OK!"


# === Автозапуск и старт ===
echo -e "[9/9] Starting RayGate...\n"
rm -f /opt/etc/rc.d/S99raygate
/opt/etc/init.d/S99raygate enable
/opt/etc/init.d/S99raygate start
echo "[9/9] RayGate started!"

# === Итог ===
BR_IP=$(ip -o -4 addr show dev "$IFACE" | awk '{print $4}' | cut -d/ -f1)
echo "=== Installation complete! ==="
echo "Web UI available at: http://$BR_IP:9090"
echo "=== Enjoy! ==="
