#!/bin/sh
### BEGIN INIT INFO
# Provides:          xray
# Required-Start:    $network
# Required-Stop:     $network
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: Xray service control
### END INIT INFO

TUN_PORT=$(grep -A2 '"tag": "tproxy-in"' /opt/etc/xray/config.json | grep '"port"' | grep -oE '[0-9]+')
IFACE="__IFACE__"
XRAY_BIN="/opt/sbin/xray"
XRAY_CONF="/opt/etc/xray/config.json"
XRAY_LOG_DIR="/opt/var/log/xray"
XRAY_LOG_FILE="$XRAY_LOG_DIR/xray_output.log"
PID_FILE="/opt/var/run/xray.pid"

# веб морда
RAYWEB_DIR="/opt/bin/raygate/rayweb"
RAYWEB_LOG="$RAYWEB_DIR/rayweb.log"
RAYWEB_PID_FILE="/opt/var/run/rayweb.pid"

get_uptime() {
    pid="$1"
    if [ -f "/proc/$pid/stat" ]; then
        proc_start=$(awk '{print $22}' /proc/$pid/stat)
        hz=100
        sys_uptime=$(awk '{print int($1)}' /proc/uptime)
        proc_uptime=$(( sys_uptime - (proc_start / hz) ))
        printf "%dd %02dh %02dm %02ds" \
            $((proc_uptime/86400)) \
            $((proc_uptime%86400/3600)) \
            $((proc_uptime%3600/60)) \
            $((proc_uptime%60))
    fi
}

check_xray_running() {
    if [ -f "$PID_FILE" ]; then
        pid=$(cat "$PID_FILE")
        if [ -n "$pid" ] && ps -p "$pid" >/dev/null 2>&1; then
            return 0
        fi
    fi
    if pgrep -f "$XRAY_BIN run" >/dev/null 2>&1; then
        return 0
    fi
    return 1
}

get_xray_pid() {
    if [ -f "$PID_FILE" ]; then
        pid=$(cat "$PID_FILE")
        if [ -n "$pid" ] && ps -p "$pid" >/dev/null 2>&1; then
            echo "$pid"
            return
        fi
    fi
    pgrep -f "$XRAY_BIN run" | head -n 1
}

start_rayweb() {
    if pgrep -f "python3 $RAYWEB_DIR/rayweb.py" >/dev/null 2>&1; then
        echo "[RAYGATE] RayWeb already running. ⚠️"
    else
        echo "[RAYGATE] Starting RayWeb..."
        cd "$RAYWEB_DIR" || exit
        python3 "$RAYWEB_DIR/rayweb.py" >> "$RAYWEB_LOG" 2>&1 &
        echo $! > "$RAYWEB_PID_FILE"
        sleep 1
        if pgrep -f "python3 $RAYWEB_DIR/rayweb.py" >/dev/null 2>&1; then
            echo "[RAYGATE] RayWeb started with PID $(cat "$RAYWEB_PID_FILE") ✅"
        else
            echo "[RAYGATE] Failed to start RayWeb. Check $RAYWEB_LOG for details. ❌"
        fi
    fi
}

case "$1" in

enable)
    echo "[RAYGATE] Enabling RayGate to autostart..."
    ln -s "$0" /opt/etc/rc.d/S99raygate 
    ;;

disable)
    echo "[RAYGATE] Disabling RayGate from autostart..."
    rm -f /opt/etc/rc.d/S99raygate
    ;;

start)
    echo "[RAYGATE] Starting Xray..."

    if [ -f "$PID_FILE" ] && ! ps -p "$(cat "$PID_FILE")" >/dev/null 2>&1; then
      rm -f "$PID_FILE"
    fi

    if ! ipset list vpn_domains >/dev/null 2>&1; then
        ipset create vpn_domains hash:ip timeout 900
        echo "[RAYGATE] Created ipset vpn_domains (timeout=900)"
    fi

    if [ ! -x "$XRAY_BIN" ]; then
      echo "[RAYGATE] Xray binary not found at $XRAY_BIN ❌"
      exit 1
    fi

    $XRAY_BIN run -test -c "$XRAY_CONF" >/tmp/xray_test.log 2>&1
    if [ $? -ne 0 ]; then
      echo "[RAYGATE] Config check failed! ❌"
      echo "See /tmp/xray_test.log: "
      tail -n 20 /tmp/xray_test.log
      exit 1
    fi

    mkdir -p "$XRAY_LOG_DIR"
    rm -f "$XRAY_LOG_FILE"

    "$XRAY_BIN" run -c "$XRAY_CONF" >>"$XRAY_LOG_FILE" 2>&1 &
    echo $! > "$PID_FILE"

    sleep 2

    if check_xray_running; then
      echo "[RAYGATE] Xray started (PID: $(get_xray_pid)) ✅"
      start_rayweb
    else
      echo "[RAYGATE] Xray failed to start. ❌"
      echo "Last log lines:"
      tail -n 20 "$XRAY_LOG_FILE"
      rm -f "$PID_FILE"
      exit 1
    fi
    ;;

  stop)
    echo "[RAYGATE] Stopping Xray..."
    if check_xray_running; then
      for pid in $(pgrep -f "$XRAY_BIN run"); do
        kill "$pid" 2>/dev/null
      done
      sleep 1
      if pgrep -f "$XRAY_BIN run" >/dev/null 2>&1; then
        echo "[RAYGATE] Some XRAY processes still alive, killing forcefully... ⚠️"
        pkill -9 -f "$XRAY_BIN run"
      fi
      rm -f "$PID_FILE"
      rm -f "$XRAY_LOG_FILE"
      echo "[RAYGATE] Xray stopped ✅"
    else
      echo "[RAYGATE] Xray is not running ⚠️"
    fi
    sleep 1
    ;;

  restart)
    $0 stop
    sleep 1
    $0 start
    ;;

  status)
    if check_xray_running; then
      pid=$(get_xray_pid)
      echo "[RAYGATE] Xray is running (PID: $pid, Uptime: $(get_uptime "$pid")) ✅"
    else
      echo "[RAYGATE] Xray is not running ⚠️"
    fi

    if pgrep -f "rayweb.py" >/dev/null 2>&1; then
        wpid=$(pgrep -f "rayweb.py" | head -n1)
        echo "[RAYGATE] RayWeb is running (PID: $wpid, Uptime: $(get_uptime "$wpid")) ✅"
    else
        echo "[RAYGATE] RayWeb is not running ⚠️"
    fi

    ;;

  *)
    echo "[RAYGATE] Usage: $0 {start|stop|restart|status}"
    exit 1
    ;;
esac

